import{e as m,W as S}from"./index.eF3rHG4W.js";import{a as g}from"./index.DgoachrA.js";const F=Symbol("kTaskCancelled");class C extends Error{}function p(i,t={}){const e=new AbortController,r=()=>e.abort(new C),n=t.signal;let s=i(e.signal);return n&&(s=s.finally(()=>n.removeEventListener("abort",r)),n.addEventListener("abort",r,{once:!0})),{promise:t.ignoreCancel?s.catch(o=>{if(!(o instanceof C))throw o;return F}):s,cancel(){e.abort(new C)}}}function R(){if(typeof Promise.withResolvers=="function")return Promise.withResolvers();let i,t;const e=new Promise((r,n)=>{i=r,t=n});return{resolve:i,reject:t,promise:e}}function H(i){return new Promise(t=>setTimeout(t,1e4))}function I(){return new Promise(i=>{setTimeout(i)})}const f="\x1B[0m",d={reset:f,clear:"\x1B[g",red:i=>`\x1B[1;31m${i}${f}`,gray:i=>`\x1B[37m${i}${f}`,green:i=>`\x1B[1;32m${i}${f}`,magenta:i=>`\x1B[35m${i}${f}`};function D(){const i="SharedArrayBuffer"in window,t=navigator.userAgent.includes("Chrome"),e=navigator.userAgent.includes("Firefox"),r=navigator.userAgent.includes("Safari");if(i&&(t||e))return!0;if(i&&r){const n=navigator.userAgent.match(/Version\/(\d+)\.(\d+) (?:Mobile\/.*?)?Safari/),s=n?Number(n?.[1]):0,o=n?Number(n?.[2]):0;return s>16||s===16&&o>=4}try{return!!localStorage.getItem("webcontainer_any_ua")}catch{return!1}}class y{prepareCommands;mainCommand;constructor({prepareCommands:t,mainCommand:e}){this.prepareCommands=t?.map(r=>new h(r)),this.mainCommand=e?new h(e):void 0}[Symbol.iterator](){const t=this;return function*(){for(const e of t.prepareCommands??[])yield e;t.mainCommand&&(yield t.mainCommand)}()}}class h{shellCommand;title;constructor(t){this.shellCommand=h.toShellCommand(t),this.title=h.toTitle(t)}isRunnable(){return this.shellCommand!==""}static equals(t,e){return t.shellCommand===e.shellCommand}static toTitle(t){let e="";return typeof t=="string"?e=t:Array.isArray(t)?e=t[1]:e=t.title,e}static toShellCommand(t){return typeof t=="string"?t:Array.isArray(t)?t[0]:t.command}}class b{port;ready;title;baseUrl;pathname;get url(){if(this.baseUrl)return new URL(this.pathname??"/",this.baseUrl).toString()}constructor(t,e){typeof t=="number"?this.port=t:Array.isArray(t)?(this.port=t[0],this.title=t[1]):(this.port=t.port,this.title=t.title),this.ready=!!e}static equals(t,e){return t.port===e.port&&t.pathname===e.pathname&&t.title===e.title}}async function x(i,t){const e=await i.spawn("/bin/jsh",["--osc"],{terminal:{cols:t.cols??80,rows:t.rows??15}}),r=e.input.getWriter(),n=e.output,s=R();let o=!1;return n.pipeTo(new WritableStream({write(a){if(!o){const[,l]=a.match(/\x1b\]654;([^\x07]+)\x07/)||[];l==="interactive"&&(o=!0,s.resolve())}t.write(a)}})),t.onData(a=>{o&&r.write(a)}),await s.promise,e}class W{steps=g(void 0);setFromCommands(t){t.length>0?this.steps.set(t.map(e=>({title:e.title,status:"idle"}))):this.steps.set(void 0)}updateStep(t,e){const r=this.steps.value;r&&this.steps.set([...r.slice(0,t),e,...r.slice(t+1)])}skipRemaining(t){const e=this.steps.value;e&&this.steps.set([...e.slice(0,t),...e.slice(t).map(r=>({...r,status:"skipped"}))])}}function E(i,t){const e={},r=[];for(const n in i){const s=i[n],o=t[n];typeof o>"u"?r.push(n):s!==o&&(e[n]=o)}for(const n in t)n in i||(e[n]=t[n]);return{addedOrModified:e,removed:r}}function v(i){const t={};for(const e in i){const r=e.split("/").filter(s=>s);let n=t;for(let s=0;s<r.length;++s){const o=r[s];if(s===r.length-1)n[o]={file:{contents:i[e]}};else{let a=n[o];$(a),a||(a={directory:{}},n[o]=a),n=a.directory}}}return t}function $(i){if(i&&!("directory"in i))throw new Error("Expected directory node")}class L{_config;constructor(t){const e=J(t);this._config=e}get panels(){return this._config.panels}get activePanel(){return this._config.activePanel}}const M={output:"Output",terminal:"Terminal"};let j=0;class u{type;static panelCount={output:0,terminal:0};static resetCount(){this.panelCount={output:0,terminal:0}}name;id;_terminal;_process;_data=[];_onData;constructor(t,e,r){if(this.type=t,!e){e=M[t];const n=u.panelCount[t];n>0&&(e+=` ${n}`),u.panelCount[t]++}this.name=e,this.id=r??(t==="output"?"output":`${t}-${j++}`)}get terminal(){return this._terminal}get process(){return this._process}get cols(){return this._terminal?.cols}get rows(){return this._terminal?.rows}reset(){this._terminal?this._terminal.reset():this._data=[]}write(t){this._terminal?this._terminal.write(t):this._data.push(t)}onData(t){this._terminal?this._terminal.onData(t):this._onData=t}attachProcess(t){this._process=t,this.cols!=null&&this.rows!=null&&this._process.resize({cols:this.cols,rows:this.rows})}attachTerminal(t){for(const e of this._data)t.write(e);this._data=[],this._terminal=t,this._onData&&t.onData(this._onData),this.cols!=null&&this.rows!=null&&this._process?.resize({cols:this.cols,rows:this.rows})}}function J(i){let t=0;if(i===!1)return{panels:[],activePanel:t};if(u.resetCount(),i===void 0||i===!0)return{panels:[new u("output")],activePanel:t};const e=[];if(i.panels){if(i.panels==="output")e.push(new u("output"));else if(i.panels==="terminal")e.push(new u("terminal"));else if(Array.isArray(i.panels))for(const r of i.panels){const[n,s={}]=Array.isArray(r)?r:[r];let o,a;typeof s=="string"?o=s:(o=s.name,a=s.id),e.push(new u(n,o,a))}}return typeof i.activePanel=="number"&&(t=i.activePanel,t>=e.length&&(t=0)),{activePanel:t,panels:e}}class N{_webcontainer;_useAuth;_webcontainerLoaded=!1;_currentLoadTask=void 0;_currentProcessTask=void 0;_currentCommandProcess=void 0;_currentTemplate=void 0;_currentFiles=void 0;_currentRunCommands=void 0;_output=void 0;_packageJsonDirty=!1;_packageJsonContent="";_availablePreviews=new Map;_previewsLayout=[];_stepController=new W;get steps(){return this._stepController.steps}previews=g([]);terminalConfig=g(new L);constructor(t,e=!1){this._webcontainer=t,this._useAuth=e,this._init()}async _init(){const t=await this._webcontainer;this._webcontainerLoaded=!0,t.on("port",(e,r,n)=>{let s=this._availablePreviews.get(e);s||(s=new b(e,r==="open"),this._availablePreviews.set(e,s)),s.ready=r==="open",s.baseUrl=n,this._previewsLayout.length===0?this.previews.set([s]):(this._previewsLayout=[...this._previewsLayout],this.previews.set(this._previewsLayout))})}setPreviews(t=!0){if(t===!1){this.previews.set([]);return}const e=t===!0?[]:t??[],r=e.map(s=>{const o=new b(s);let a=this._availablePreviews.get(o.port);return a?a.title=o.title:(a=o,this._availablePreviews.set(a.port,a)),a});let n=r.length!=this._previewsLayout.length;if(!n)for(let s=0;s<r.length&&(n=!b.equals(r[s],this._previewsLayout[s]),!n);s++);if(n)if(this._previewsLayout=r,e.length===0){const s=this._availablePreviews.values().next().value;this.previews.set(s?[s]:[])}else this.previews.set(this._previewsLayout)}setTerminalConfiguration(t){const e=this.terminalConfig.get(),r=new L(t),n=new Map(e.panels.map(s=>[s.id,s]));for(const s of r.panels)try{const o=n.get(s.id);n.delete(s.id),o?.terminal&&s.attachTerminal(o.terminal),s.type==="output"&&(this._currentCommandProcess&&s.attachProcess(this._currentCommandProcess),this._output=s),s.type==="terminal"&&!o&&this._bootWebContainer(s).then(async a=>{s.attachProcess(await x(a,s))})}catch{}for(const s of n.values())s.process?.kill();this.terminalConfig.set(r)}updateFile(t,e){const r=this._currentLoadTask?.promise;this._currentLoadTask=p(async n=>{await r;const s=await this._webcontainer;n.throwIfAborted(),await s.fs.writeFile(t,e),this._updateCurrentFiles({[t]:e})},{ignoreCancel:!0})}updateFiles(t){const e=this._currentLoadTask?.promise;this._currentLoadTask=p(async r=>{await e;const n=await this._webcontainer;r.throwIfAborted(),await n.mount(v(t)),this._updateCurrentFiles(t)},{ignoreCancel:!0})}prepareFiles({files:t,template:e,signal:r,abortPreviousLoad:n=!0}){const s=this._currentLoadTask?.promise;return n&&this._currentLoadTask?.cancel(),this._currentLoadTask=p(async o=>{await s;const a=await this._webcontainer;o.throwIfAborted(),[e,t]=await Promise.all([e,t]),o.throwIfAborted(),this._currentFiles||this._currentTemplate?await z(a,{...this._currentTemplate,...this._currentFiles},{...e,...t}):await a.mount(v({...e,...t})),this._currentTemplate={...e},this._currentFiles={...t},this._updateDirtyState(t)},{ignoreCancel:!0,signal:r}),this._currentLoadTask.promise}async attachTerminal(t,e){const r=this.terminalConfig.get().panels.find(n=>n.id===t);r&&r.attachTerminal(e)}onTerminalResize(t,e){if(t&&e)for(const r of this.terminalConfig.get().panels)r.process?.resize({cols:t,rows:e})}runCommands({abortPreviousRun:t=!0,...e}){const r=this._currentProcessTask,n=this._currentLoadTask?.promise,s=new y(e);let o=this._changeDetection(e);o&&this._stepController.setFromCommands([...s]),this._currentProcessTask=p(async a=>{if(await n,a.aborted&&t&&r?.cancel(),a.throwIfAborted(),o||=this._changeDetection(e),!o){if(r){const c=()=>r.cancel();return a.addEventListener("abort",c,{once:!0}),r.promise}return}t&&r?.cancel(),this._currentRunCommands=s,await r?.promise;const l=await this._webcontainer;return a.throwIfAborted(),this._runCommands(l,s,a)},{ignoreCancel:!0})}restartLastRunCommands(){if(!this._currentRunCommands)return;const t=this._currentRunCommands,e=this._currentProcessTask?.promise,r=this._currentLoadTask?.promise;this._currentProcessTask?.cancel(),this._currentProcessTask=p(async n=>{await Promise.all([e,r]);const s=await this._webcontainer;return n.throwIfAborted(),this._runCommands(s,t,n)},{ignoreCancel:!0})}async _runCommands(t,e,r){w(this._output);const n=()=>this._currentCommandProcess?.kill();r.addEventListener("abort",n,{once:!0});const s=!!e.mainCommand;try{const o=[...e];this._stepController.setFromCommands(o);let a=0;for(const[l,c]of o.entries()){const A=l===o.length-1&&!!e.mainCommand;if(!c.isRunnable()){this._stepController.updateStep(l,{title:c.title,status:"skipped"});continue}this._stepController.updateStep(l,{title:c.title,status:"running"}),a>0&&this._output?.write(`
`),a++,this._currentCommandProcess=await this._newProcess(t,c.shellCommand);try{r.throwIfAborted()}catch(_){throw this._stepController.skipRemaining(l),_}if(A&&this._clearDirtyState(),await this._currentCommandProcess.exit!==0){this._stepController.updateStep(l,{title:c.title,status:"failed"}),this._stepController.skipRemaining(l+1);break}else this._stepController.updateStep(l,{title:c.title,status:"completed"});try{r.throwIfAborted()}catch(_){throw this._stepController.skipRemaining(l+1),_}}s||this._clearDirtyState()}finally{r.removeEventListener("abort",n)}}async _newProcess(t,e){const[r,...n]=e.split(" ");this._output?.write(`${d.magenta("❯")} ${d.green(r)} ${n.join(" ")}
`);const s=await t.spawn(r,n,{terminal:this._output?{cols:this._output.cols??80,rows:this._output.rows??15}:void 0});return s.output.pipeTo(new WritableStream({write:o=>this._output?.write(o)})),s}_updateDirtyState(t){for(const e in t)if(e.endsWith("/package.json")&&t[e]!=this._packageJsonContent){this._packageJsonContent=t[e],this._packageJsonDirty=!0;return}}_updateCurrentFiles(t){if(this._currentFiles)for(const e in t)this._currentFiles[e]=t[e];else this._currentFiles={...t};this._updateDirtyState(t)}_clearDirtyState(){this._packageJsonDirty=!1}_changeDetection(t){if(this._packageJsonDirty||!this._currentRunCommands)return!0;const e=k(this._currentRunCommands),r=k(t);if(e.length!==r.length)return!0;for(let n=0;n<e.length;++n)if(!h.equals(e[n],r[n]))return!0;return!1}async _bootWebContainer(t){B(t);const e=this._webcontainerLoaded;this._useAuth&&!e&&(t.write("Waiting for authentication to complete..."),await m.loggedIn(),w(t)),e||t.write("Booting WebContainer...");try{const r=await this._webcontainer;return e||w(t),r}catch(r){throw w(t),await I(),t.write([d.red("Looks like your browser's configuration is blocking WebContainers."),"","Let's troubleshoot this!","","Read more at:","https://webcontainers.io/guides/browser-config",""].join(`
`)),r}}}function w(i){i?.reset(),i?.write(d.clear)}function k(i){return i instanceof y?[...i].filter(t=>t.isRunnable()):k(new y(i))}async function z(i,t,e){const{removed:r,addedOrModified:n}=E(t,e);for(const s of r)await i.fs.rm(s,{force:!0});await i.mount(v(n))}function B(i){if(!D())throw i.write([d.red("Incompatible Web Browser"),"","WebContainers currently work in Chromium-based browsers, Firefox, and Safari 16.4. We're hoping to add support for more browsers as they implement the necessary Web Platform features.","","Read more about browser support:","https://webcontainers.io/guides/browser-support",""].join(`
`)),new Error("Incompatible Web Browser")}const T=!1;let P=new Promise(()=>{});P=Promise.resolve(null).then(()=>S.boot({workdirName:"tutorial"})),P.then(()=>{U.loaded=!0});const G=new N(P,T);async function K(){m.startAuthFlow({popup:!0}),await m.loggedIn()}function Q(){m.logout({ignoreRevokeError:!0})}const U={useAuth:T,loggedIn:()=>m.loggedIn(),loaded:!1};export{Q as a,K as l,p as n,G as t,H as w};
